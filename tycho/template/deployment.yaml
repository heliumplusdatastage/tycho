{%- for container in system.containers -%}    
{%- if container.replicas > 1 %}
---
#
# This template generates a deployment object. It is a component of a design
# in which all single instance containers reside in a single pod. Containers with
# replicas > 1 each get their own deployment. This is the template for those multi-replica
# containers.
#
#  Generated by Tycho {{ now() }}
#
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: {{ system.name }}-{{ loop.index }}
  labels:
    name: {{ system.name }}-{{ loop.index }}
    executor: tycho
    tycho-guid: {{ system.identifier }}
spec:
  selector:
    matchLabels:
      run: {{ system.name }}
#      executor: tycho
#      tycho-guid: {{ system.identifier }}
  replicas: {{ container.replicas }}
  template:
    metadata:
      labels:
        run: {{ system.name }}
    spec:
      {%- if (container.limits or container.requests) and container.limits.gpus != None -%}
      nodeSelector:
        nvidia.com/gpu: "true"
        tolerations:
          - key: "nvidia.com/gpu"
            operator: "Exists"
            effect: "NoSchedule"
      {%- endif %}
      containers:
      - name: {{ container.name }}
        image: {{ container.image }}
        imagePullPolicy: {{ system.image_pull_policy () }}
        {%- if container.command %}
        command: {{ container.command }}
        {%- endif %}
        env:
          - name : GUID
            value: {{ system.identifier }}
          {%- if container.env -%}
          {%- for e in container.env %}
          - name : {{ e[0] }}
            value : "{{ e[1] }}"
          {%- endfor -%}
          {%- endif %}
        {%- if container.expose|length > 0 %}
        ports:
          {%- for port in container.expose -%}
          - containerPort: {{ container.expose[loop.index-1]['containerPort'] }}
            protocol: TCP
          {%- endfor -%}     
        {%- endif -%}
        {%- if container.limits or container.requests %}
        resources:
          {%- if container.limits and container.limits.cpus != None %}
          limits:
            cpu: "{{ container.limits.cpus }}"
            memory: "{{ container.limits.memory }}"
          {%- endif -%}
          {%- if container.requests and container.requests.cpus != None %}
          requests:
            cpu: "{{ container.requests.cpus }}"
            memory: "{{ container.requests.memory }}"
          {%- endif -%}
          {%- if container.limits.gpus != None-%}
          limits:
            nvidia.com/gpu: {{ container.limits.gpus }}
            memory: {{ container.limits.memory }}
          {%- endif -%}
        {%- endif -%}
        {%- if container.volumes -%}
        volumeMounts:
          {%- for volume in system.volumes -%}
          {%- if container.name == volume['container_name'] %}
          - name: {{ volume["volume_name"] }}
            mountPath: {{ volume["mount_path"] }}
            readOnly: false
          {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- if container.volumes -%}
      volumes:
        {%- for volume in system.volumes -%}
        {%- if container.name == volume['container_name']-%}
        {%- if volume["claim_name"] != "NA" %}
        - name: {{ volume["volume_name"] }}
          persistentVolumeClaim:
            claimName: {{ volume["claim_name"] }}
        {%- endif -%}
        {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
{%- endif -%}
{%- endfor -%}
